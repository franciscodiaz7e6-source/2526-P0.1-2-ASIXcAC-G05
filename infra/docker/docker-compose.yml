version: '3.9'

services:
  # ============================================
  # NGINX - Reverse Proxy & Load Balancer
  # ============================================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: extagram-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      # Configuracion
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # Codigo PHP
      - ../src/web/php:/app:ro
      # Archivos estaticos
      - ../src/web/static/css:/static/css:rw
      - ../src/web/static/js:/static/js:rw
      - ../src/web/static/images:/static/images:rw
      # Uploads (para servir fotos)
      - ./volumes/uploads:/uploads:ro
    depends_on:
      - php-app-1
      - php-app-2
      - php-upload
      - storage
    networks:
      - extagram-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # PHP-FPM - Instancia 1 (Lectura)
  # ============================================
  php-app-1:
    build:
      context: ./php
      dockerfile: Dockerfile
    container_name: extagram-php-1
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_NAME: extagram_db
      DB_USER: extagram_user
      DB_PASS: secure_password_123
    volumes:
      - ../src/web/php:/app:ro
    depends_on:
      - mysql
    networks:
      - extagram-net

  # ============================================
  # PHP-FPM - Instancia 2 (Lectura)
  # ============================================
  php-app-2:
    build:
      context: ./php
      dockerfile: Dockerfile
    container_name: extagram-php-2
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_NAME: extagram_db
      DB_USER: extagram_user
      DB_PASS: secure_password_123
    volumes:
      - ../src/web/php:/app:ro
    depends_on:
      - mysql
    networks:
      - extagram-net

  # ============================================
  # PHP-FPM - Upload (Escritura en /uploads)
  # ============================================
  php-upload:
    build:
      context: ./php
      dockerfile: Dockerfile
    container_name: extagram-php-upload
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_NAME: extagram_db
      DB_USER: extagram_user
      DB_PASS: secure_password_123
    volumes:
      - ../src/web/php:/app:ro
      - ./volumes/uploads:/uploads:rw
    depends_on:
      - mysql
    networks:
      - extagram-net

  # ============================================
  # NGINX - Storage (Sirve archivos estaticos)
  # ============================================
  storage:
    image: nginx:alpine
    container_name: extagram-storage
    restart: unless-stopped
    volumes:
      - ../src/web/static:/usr/share/nginx/html:rw
      - ./volumes/uploads:/usr/share/nginx/html/uploads:rw
    networks:
      - extagram-net

  # ============================================
  # MySQL 8.0 - Base de Datos
  # ============================================
  mysql:
    image: mysql:8.0
    container_name: extagram-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_secure_123
      MYSQL_DATABASE: extagram_db
      MYSQL_USER: extagram_user
      MYSQL_PASSWORD: secure_password_123
    volumes:
      - mysql-data:/var/lib/mysql
      - ../src/database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - extagram-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3

# ============================================
# VOLUMENES - Persistencia
# ============================================
volumes:
  mysql-data:
    driver: local

# ============================================
# RED INTERNA
# ============================================
networks:
  extagram-net:
    driver: bridge